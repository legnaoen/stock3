# SSOT – 주식 시장 데이터 자동 분석·추천 시스템

> **[중요] 이 문서는 항상 시스템 명령어 `date "+%Y-%m-%d"`로 오늘 날짜를 확인하여 기록/갱신합니다. (수동/추론/하드코딩 금지)**

---
> **🎯 이 문서의 목적**: AI와의 바이브코딩에서 맥락 유지, 불필요한 코드 재작성 방지, 안정적 기능 보호

## 프로젝트 계획

### 1. 과제명
- 주식 시장 데이터 자동 수집·분석·추천 시스템 (MVP)
- (확장형 AI 기반 투자 리서치 플랫폼 기초 구축)

### 2. 목표 및 개요
- 국내 주식 시장의 모든 종목에 대한 가격, 거래량, 업종·테마, 재무, 뉴스 등 핵심 데이터를 자동으로 수집 및 가공
- 업종/테마 트렌드, 주도주, 주요 이슈, 투자 매력도 등 실전 투자 인사이트를 자동 리포트 형태로 제공
- LLM 등 AI 분석 연계 및 SaaS 사업화가 가능한 모듈형 데이터 인프라 설계/구축

#### 핵심 가치
- 실전 투자 자동화 리서치: 시장 흐름과 종목 특징을 자동 분석, 투자 의사결정 정보 신속 제공
- 데이터/분석 API 기반: 외부 시스템/사용자에 API 형태로 데이터·분석 결과 제공
- 유연한 확장성: MVP 이후 단계적 기능 확장(개인화, 전략 백테스트, 외부 연동 등)에 최적화된 구조

### 3. MVP 단계 주요 기능 및 구성
- **DB 중심 파이프라인:** 모든 데이터는 즉시 DB에 저장, 각 모듈은 DB에서 읽고 결과도 DB에 저장
- **데이터 수집:** 종목정보, 업종/테마, 시세, 재무, 뉴스 등 다양한 소스(PyKRX, DART, Selenium 등)에서 자동 수집
- **분석/가공:** 업종/테마별 등락률, 주도주 추출, 이슈 매핑/요약, 투자매력 점수화 등
- **LLM 연동:** DB 기반 질의응답, 뉴스/이슈 요약, 투자 인사이트 자동화
- **확장성:** 각 기능은 독립 모듈, DB 중심, 스케줄러/컨테이너화, API 제공 등

## 1. 프로젝트 개요

- **목적:** 국내 주식 시장의 모든 종목에 대한 가격, 거래량, 업종·테마, 재무, 뉴스 등 핵심 데이터를 자동으로 수집·가공하고, 실전 투자에 필요한 인사이트(업종/테마 트렌드, 주도주, 주요 이슈, 투자 매력도 등)를 자동 리포트 형태로 제공
- **배경:** 데이터 기반 실전 투자 자동화, LLM 등 AI 분석 연계 및 SaaS 사업화까지 확장 가능한 모듈형 데이터 인프라 구축
- **주요 기능:**
  1. DB 중심 데이터 수집 파이프라인 (PyKRX, DART, Selenium 등)
  2. 업종/테마/주도주/이슈/투자매력도 등 자동 분석 및 점수화
  3. LLM 연동 질의응답/자동 리포트/뉴스 요약
  4. API/외부 연동 및 확장성 지원
- **적용 범위:** 국내 상장주식 전체, 실전 투자자/리서치/AI 서비스 등
- **신경 쓸 점:** 
  - 모든 데이터/분석 결과는 반드시 DB(SSOT)에 저장, 각 모듈은 DB에서 읽고 결과도 DB에 저장
  - 크롤링 소스(네이버 등) 변경에 취약, 주기적 모니터링 및 유지보수 필요
  - API/LLM 사용량/비용 관리, 데이터 신뢰도 검증 자동화
- **협업자/관리자:** [작성자명]

---

## 2. 바이브 코딩 운영·실행 지침

1. 작업은 "부분 수정/최소 변경"을 원칙으로 한다. 전체 파일 재작성은 예외적 상황만 허용.
2. 작업 범위·목적·제약을 먼저 명확히 한다.
3. 필요한 코드/정보만 입력·수정 요청한다.
4. 불필요한 반복, 탐색, 포맷팅, 자동화 명령은 최소화한다.
5. 작업 전후에는 SSOT(설계/운영 문서)를 반드시 확인·갱신한다.
6. AI 작업 결과는 항상 직접 확인·검토하고, 문제가 있으면 즉시 수정·피드백한다.
7. 모든 작업/자동화는 "최소 입력, 최대 명확성" 원칙을 따른다.
8. 예외상황(전체 재작성, 구조 변경 등)은 반드시 직접 확인/동의 후 진행한다.

---

## 3. 진행관리/변경 이력

| 날짜       | 작성자      | 변경 내용           | 비고                    |
| ---------- | ----------- | ------------------ | ----------------------- |
| 2025-06-12 | [작성자]    | reference.md 기반 실전 SSOT 반영 | 구조/주요 내용 실전화  |
| 2025-06-17 | [작성자]    | 업종/테마 등락률 계산 로직 변경 | 업종 100%, 테마 662종목 매핑, 날짜별 이력화 |
| 2025-06-17 | [작성자]    | 테마/업종 상세 페이지 구현 | 개별 종목 리스트와 등락률 확인 기능 추가 |
| 2025-06-17 | [작성자]    | 테마 등락률 계산 방식 변경 | 네이버 테마 지수와의 정합성 개선 |
| 2025-06-18 | [작성자]    | krx_collector.py fill_missing_history() 과거 시세 백필 기능 실전 적용, 파생지표(60일 저점, 5일 평균 거래대금) 보충, 안전장치/예외처리/운영 이력 상세화 | 실전 데이터 자동화/분석 파이프라인 확장, 운영 안전성 강화 |
| 2025-06-18 | [작성자]    | UI/차트/상세페이지 개선: 업종/테마 등락률 연동, 종목상세 내부링크, 캔들차트 한국식 컬러 등 최신화 | 실전 운영/UX 개선 |
| 2025-06-18 | [작성자]    | Python import 오류 해결: UI(app.py) 등 모든 실행은 반드시 프로젝트 루트에서 `python -m src.ui.app` 방식으로 실행, sys.path 및 from src.xxx import 패턴 공식화. 뉴스크롤러-UI 연동 정상화. | 운영/실행 표준 SSOT 반영 |
| 2025-06-18 | [작성자]    | 네이버 금융 재무정보 크롤러 개선: 연간/분기 데이터 정확한 구분 처리. 배당금, 매출액, 영업이익 등 주요 재무지표 모두 정상 수집. 예상치(E) 데이터도 정확하게 구분하여 저장. | 재무정보 데이터 품질 개선 |
| 2025-06-18 | [작성자]    | 재무제표 분석기(FinancialStatementAnalyzer) 구현: 성장성, 수익성, 안정성, 시장가치 4개 영역 평가 및 점수화. 삼성전자 등 실제 종목 테스트 완료. 분석 결과는 financial_evaluation 테이블에 저장. | 재무제표 기반 종목 평가 자동화 |
| 2025-06-19 | [작성자]    | 재무정보 수동 업데이트 기능 추가: 종목 상세 페이지에 재무정보 업데이트 버튼 추가. 백엔드 API 엔드포인트(/api/v1/update_financial) 구현. | 재무정보 실시간 업데이트 지원 |
| 2025-06-21 | [작성자]    | 모멘텀 분석 시스템 고도화 (1단계): 데이터 파이프라인 정비 및 RSI 지표 추가. | 분석의 신뢰성 확보 |
| 2025-06-21 | [작성자]    | 모멘텀 분석 시스템 고도화 (2단계): 투자 의견 분석기(`investment_analyzer.py`) 신설 및 투자 의견 자동 생성. | 분석 시스템의 모듈화 및 자동화 |
| 2025-06-21 | [작성자]    | 주도주 선정 알고리즘 개선: 다양한 예외 케이스(거래대금, 등락률)를 처리하기 위한 하이브리드 로직 적용. 중앙값(Median) 기반 필터링과 안전장치(상승률 1위 강제 지정) 추가. | 주도주 분석의 정확성 및 안정성 대폭 향상 |
| 2025-06-21 | [작성자]    | 업종&테마(혼합) 탭 종합점수/의견 표시 오류 진단 및 해결: 백엔드 row 인덱스/프론트 변환/실데이터 로그 점검, 정상화 확인. 시가총액 누락분 pykrx로 보충, 집계 테이블 전체 재생성, 모멘텀/지표 분석 결과 정상화. 전체 파이프라인(마스터→집계→분석→UI) 점검 및 SSOT 최신화. | 실전 데이터 품질/분석/프론트 연동 완전 정상화 |
| 2025-06-22 | [작성자]    | 윈도우 환경 venv 강제 체크 완화 | 주요 collector/analyzer/scripts 파일에서 os.name=='nt'일 때 venv 체크 패스하도록 조건문 분기 적용. 윈도우에서는 venv 미사용 가능, 맥/리눅스는 기존대로 venv 강제. |
| 2025-06-22 | [작성자]    | 투자분석기/모멘텀 파이프라인 구조분리, 실전/실험/리포트 분리, 진단로그/결측치/분포/DB정상화, 브랜치(win-250622-3) 백업 | 실전/실험/리포트 완전 분리, 분석기 진단로그/분포/DB정상화, 깃 브랜치 백업 |
| 2025-06-22 | [작성자]    | update_active_weights.py: 최적화 가중치(best_row) → 실전 가중치(momentum_weights_active.csv) 반영 구조 명확화 | 실전/실험/리포트 파이프라인 분리 구조 실제 적용 예시 추가 |
| 2025-06-23 | [작성자]    | 백테스트 추천 가중치와 실전 가중치 값 100% 일치, 추가 보정 없음 | 실전/백테스트 오차 없음 명확화 |

---

## 4. 기술 스택 및 아키텍처

### 4.1 백엔드
- **언어**: Python
- **프레임워크**: FastAPI (API), Airflow/Prefect (스케줄러)
- **주요 라이브러리**:
  - PyKRX: 주식 시세/기본정보 수집
  - requests, selenium: 크롤링/ETL
  - SQLAlchemy/psycopg2: DB ORM/연결
  - pydantic: 데이터 검증
  - openai/gemini: LLM 연동

### 4.2 프론트엔드
- (MVP 단계 없음, 추후 확장)

### 4.3 파일 구조
```
stock-analytics/
├── config/                  # 환경설정(토큰/API/DB 등)
├── data/                    # 원본/샘플/임시 데이터
├── db/                      # DB 스키마, 마이그레이션, 쿼리
├── scripts/                 # 단독 실행/유틸/테스트 스크립트
├── src/
│   ├── main.py              # 메인 파이프라인
│   ├── collector/           # 데이터 수집/크롤러/ETL
│   ├── processor/           # 데이터 정제/가공/매핑
│   ├── analyzer/            # 정량/정성 분석, 점수화, 랭킹
│   ├── llm/                 # LLM(질의응답/자동 리포트)
│   ├── api/                 # API 서버
│   └── utils/               # 공통 함수/로깅/유틸
├── tests/                   # 유닛/통합 테스트
├── docker/                  # 컨테이너/배포 관련
├── airflow/                 # 워크플로/스케줄러 관리
├── docs/                    # 문서(ERD, API, 알고리즘 등)
├── .env                     # 환경변수
├── requirements.txt         # 의존성 패키지 목록
└── README.md                # 최상위 설명서
```

### 4.4 코드 품질 관리
- Python 타입힌트, mypy, flake8, black 등 적용
- DB 스키마/ERD/문서화 필수, 테스트 코드 분리
- 대량 데이터 인덱싱/파티셔닝 등 성능 최적화

### 4.x 운영/실행 표준 (Python import/실행)

- 모든 파이썬 스크립트/서버 실행은 반드시 프로젝트 루트(예: stock-3)에서 아래와 같이 실행한다:
  - `python -m src.ui.app` (Flask UI)
  - `python -m src.main` (메인 파이프라인 등)
- import는 항상 `from src.xxx` 패턴을 사용한다. (상대 import, 혼용 금지)
- src/ui/app.py 등 스크립트 상단에는 아래 코드로 sys.path를 패치한다:
  ```python
  import sys, os
  sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '../')))
  ```
- (참고) `python src/ui/app.py` 등 하위 폴더에서 직접 실행 시 import 오류 발생하므로 금지
- 뉴스크롤러 등 기존 모듈을 UI/서버에 연동할 때도 위 표준을 반드시 따른다
- 본 표준은 실전 운영/테스트/배포 환경에서 일관성, 유지보수성, 협업 효율을 보장하기 위함

---

#### [윈도우 환경 실행/이슈]
- PowerShell에서는 `&&` 명령어 연속 실행이 불가. 반드시 한 줄씩 실행:
  ```powershell
  cd stock3
  python -m src.ui.app
  ```
- 가상환경(venv) 활성화는 아래 명령어 사용:
  ```powershell
  .\venv\Scripts\Activate
  ```
- 패키지 설치 필요 시:
  ```powershell
  pip install -r requirements.txt
  ```
- 경로 구분자(`/` ↔ `\`) 자동화: 코드 내 경로는 반드시 `os.path`로 처리
- DB/파일 인코딩: 한글 경로/파일명, 인코딩 문제 발생 시 `utf-8` 명시
- 실행/경로 오류, 패키지 미설치, DB 파일 위치 등 환경 차이로 인한 문제 발생 시 SSOT에 즉시 기록
- 윈도우 환경에서 발생한 모든 이슈/해결법은 본 섹션에 누적 기록

---

## 5. 핵심 설계 결정사항

### 5.1 DB 중심 SSOT 구조
- **결정내용**: 모든 데이터/분석/결과는 반드시 DB(관계형, PostgreSQL 권장)에 저장, 각 모듈은 DB에서 읽고 결과도 DB에 저장
- **이유**: 모듈 독립성, 확장성, 유지보수, API/LLM 연동 등 유연성 확보
- **영향**: 각 기능/분석/리포트가 독립적으로 개발·운영·확장 가능, 데이터 신뢰성/일관성 보장

### 5.2 모듈화/컨테이너화/스케줄러 기반
- **결정내용**: 데이터 수집, 정제, 분석, 리포트, LLM 연동 등 각 기능을 독립 파이썬 모듈/컨테이너로 분리, Airflow/Prefect 등으로 자동화
- **이유**: 유지보수/확장/배포/운영 자동화 용이
- **영향**: 신규 기능 추가/변경/롤백/테스트가 쉽고, 실전 운영에 강함

### 5.3 크롤링/외부 API 의존성 관리
- **결정내용**: Selenium 등 크롤링은 웹사이트 변경에 취약, 주기적 모니터링 및 대체 소스(유료 API 등) 로드맵 포함
- **이유**: 데이터 신뢰성/지속성 확보
- **영향**: 크롤러 유지보수, API 전환 등 유연한 구조 필요

### 5.4 뉴스/이슈 데이터 관리 구조
- **결정내용**: 종목/테마별 뉴스/이슈 데이터는 마스터 테이블(Stocks, Themes 등)에 컬럼 추가가 아니라, 별도의 NewsArticles(뉴스 마스터), ArticleStockMap(뉴스-종목 매핑), ArticleThemeMap(뉴스-테마 매핑) 테이블로 분리 관리
- **이유**: 뉴스 데이터는 양이 많고, 종목/테마와 1:N, N:M 관계(한 뉴스가 여러 종목/테마에 매핑될 수 있음). 별도 테이블로 관리해야 확장성, 성능, 분석/검색/LLM 연동, 이력관리, 유지보수 모두에 최적화됨
- **영향**: 뉴스/이슈 크롤러, 분석, LLM, 리포트 등 전체 파이프라인에서 유연하게 활용 가능. SSOT/DB/크롤러/분석/리포트 등 전체 구조에 일관 적용

### 5.5 테마/업종 상세 분석 구조
- **결정내용**: 테마/업종별 상세 페이지에서 소속 종목 리스트와 개별 등락률을 확인할 수 있도록 구현. 시가총액 가중평균 등락률 계산의 정확성 검증을 위한 기반 마련.
- **구현내용**:
  1. 백엔드:
     - `sector_detail_analyzer.py`: 테마/업종별 상세 정보와 종목 리스트 조회
     - `sector_api.py`: REST API 엔드포인트 제공
  2. 프론트엔드:
     - `sector_detail.html`: 상세 정보 표시 페이지
     - DataTables 기반의 종목 리스트 (등락률 기준 정렬)
     - 종목별 네이버 금융 링크 연동
- **이유**: 테마/업종 등락률 계산의 정확성 검증 및 실시간 모니터링 필요
- **영향**: 등락률 계산 오차 발견 시 즉각적인 원인 파악 및 수정 가능

### 5.6 재무제표 분석기 설계
- **결정내용**: 재무제표 분석기(FinancialStatementAnalyzer)를 통해 종목별 투자 매력도를 4개 영역(성장성, 수익성, 안정성, 시장가치)으로 평가하고 점수화
- **구현내용**:
  1. 평가 영역 및 지표:
     - 성장성: 매출액 성장률, 영업이익 성장률, 순이익 성장률
     - 수익성: 영업이익률, 순이익률, ROE
     - 안정성: 부채비율, 유동비율, 당좌비율
     - 시장가치: PER, PBR, 배당수익률
  2. 데이터베이스:
     - financial_evaluation 테이블에 평가 결과 저장
     - 각 영역별 점수(0~5점)와 종합 의견 기록
  3. 분석 로직:
     - 각 지표별 산업 평균 대비 상대 평가
     - 시계열 추세 분석으로 개선/악화 여부 판단
     - 가중치 기반 종합 점수 산출
- **이유**: 객관적이고 일관된 기준으로 종목의 재무적 건전성과 투자 매력도를 평가하기 위함
- **영향**: 
  1. 종목 스크리닝 및 포트폴리오 구성의 기초 데이터로 활용
  2. LLM 기반 투자 분석/추천 시스템의 핵심 입력값으로 사용
  3. 정량적 평가 결과를 통한 투자 의사결정 지원

### 5.7 재무정보 수동 업데이트 기능
- **결정내용**: 종목 상세 페이지에서 재무정보를 수동으로 업데이트할 수 있는 기능 추가
- **구현내용**:
  1. 백엔드:
     - `/api/v1/update_financial` 엔드포인트 구현
     - 네이버 금융 크롤러를 통한 최신 재무정보 수집
     - 수집된 데이터는 financial_statements 테이블에 저장
  2. 프론트엔드:
     - 종목 상세 페이지에 '재무정보 업데이트' 버튼 추가
     - AJAX를 통한 비동기 업데이트 처리
     - 업데이트 상태 표시 (로딩/성공/실패)
- **이유**: 
  1. 재무정보의 실시간성 확보
  2. 사용자가 필요할 때 즉시 최신 데이터 확인 가능
  3. 배치 작업과 별개로 개별 종목 데이터 갱신 지원
- **영향**: 
  1. 재무제표 분석의 정확도 향상
  2. 사용자 경험 개선
  3. 시스템 부하 분산 (필요한 종목만 선택적 업데이트)

### 5.8 주도주 선정 알고리즘 고도화
- **결정내용**: 기존의 단순 상위 N개 방식에서 벗어나, 다양한 시장 상황과 예외 케이스에 대응할 수 있는 정교한 하이브리드 알고리즘을 도입.
- **구현내용**: `src/analyzer/sector_theme_analyzer.py`의 `_find_leading_stocks` 함수에 적용.
  1.  **1차 필터링 (규칙 확장)**:
      - **(일반 규칙)** `등락률 >= 5%` **AND** `거래대금 >= 30억`
      - **(예외 규칙)** **OR** `등락률 >= 20%` (거래대금이 부족해도 폭등주는 주도주로 간주)
  2.  **2차 필터링 (상대 비교 기준 현실화)**:
      - 그룹 내 종목 수가 많을 경우, 이상치(outlier)에 강건한 `중앙값(Median)`을 기준으로 필터링 (`거래대금 > 그룹 중앙값 * 2`).
  3.  **안전장치 (Fallback)**:
      - 위 모든 조건을 충족하는 주도주가 없을 경우, 그룹 내 **상승률 1위 종목을 무조건 주도주로 지정**.
- **이유**: 거래대금이 적은 소외주 급등, 특정 종목으로 거래 쏠림, 강세 테마 내 다수 종목 동반 상승 등 복잡한 실제 시장 상황을 정확하게 반영하기 위함.
- **영향**: 주도주 분석의 신뢰성과 안정성이 대폭 향상되었으며, 거의 모든 예외 상황에서 합리적인 주도주를 선정할 수 있게 됨.

---

## 단계별 진행계획

### 1단계: 데이터 파이프라인 구축 (기반 다지기)
- **목표:** 핵심 데이터(종목, 업종, 테마, 시세, 재무, 뉴스 등)를 안정적으로 수집·DB에 저장, SSOT 체계 확립
- **주요 작업:**
  - DB 스키마 정의 및 초기화 (Stocks, Industries, Themes, StockThemes, DailyStockPrices, FinancialStatements, NewsArticles 등)
  - PyKRX/DART/Selenium 기반 데이터 수집 모듈 개발 및 자동화
- **테스트 계획:**
  - 각 테이블별 샘플 데이터 적재 및 쿼리 정상 동작 확인
  - 수집 모듈별(종목, 시세, 재무, 테마, 뉴스) 단위 테스트 및 DB 적재 결과 검증
  - 데이터 누락/중복/형식 오류 자동 검증 스크립트 실행

### 2단계: 분석 로직 및 자동 리포트 생성 (가치 창출)
- **목표:** 수집 데이터 기반 업종/테마 트렌드, 주도주, 이슈, 투자매력도 등 실전 분석 및 자동 리포트 구현
- **주요 작업:**
  - 업종/테마별 등락률·거래대금 집계, 주도주/이슈 매핑, 투자매력 점수화 등 분석 모듈 개발
  - DailyIndustryTrends, DailyThemeTrends, DailyAnalysisResults 등 분석결과 DB 저장
- **테스트 계획:**
  - 분석 모듈별(트렌드, 주도주, 점수화 등) 단위 테스트 및 결과 DB 적재 검증
  - 샘플 리포트 생성 및 주요 지표(상위 테마/주도주 등) 수치 검증
  - 엣지케이스(데이터 결측, 급등락 등) 처리 검증

### 3단계: LLM 연동 및 서비스 구현 (인사이트 제공)
- **목표:** 분석 데이터 기반 LLM 질의응답, 자동 리포트, 사용자 친화적 서비스 구현
- **주요 작업:**
  - LLM API 연동, 프롬프트 템플릿, 질의응답/리포트 모듈 개발
  - LLMInteractionLogs 등 상호작용 로그 DB화, API 서버/스케줄러/배포 환경 구축
- **테스트 계획:**
  - LLM 질의응답(예시 질문)별 응답 품질 및 데이터 일치성 검증
  - LLM 상호작용 로그 기록 및 분석
  - 전체 파이프라인(수집→분석→LLM) 엔드-투-엔드 통합 테스트

---

## 11. AI 협업 가이드라인

### 11.1 매 작업 시작 시 확인사항
```
현재 상태: [정상 작동하는 기능들 나열]
작업 목표: [1줄로 정확한 목표 정의]
수정 금지: [건드리면 안 되는 코드/파일 명시]
예상 변경: [몇 개 파일, 몇 줄 정도]
타입 체크: [TypeScript 오류 여부 확인]
린트 상태: [ESLint 경고/오류 확인]
```

### 11.2 절대 금지 행동
- ❌ 정상 작동하는 전체 파일 재작성
- ❌ 요청하지 않은 "개선" 또는 "최적화" 작업
- ❌ 테스트 없는 여러 파일 동시 수정
- ❌ 10.1 안정적 코드 섹션의 함수 수정
- ❌ 타입 안전성을 해치는 `any` 타입의 무분별한 사용
- ❌ ESLint 규칙 무시 (특별한 이유 없이 disable 하기)
- ❌ React Hook 의존성 규칙 위반

### 11.3 권장 작업 패턴
1. **단일 집중**: 문제 1개 → 파일 1개 → 수정 완료 → 테스트
2. **도구 우선순위**: edit_file 우선, write_file 최소화
3. **변경 추적**: 수정 전후 비교 설명 필수
4. **상태 업데이트**: 작업 완료 후 코드 상태 맵 갱신
5. **타입 안전성**: TypeScript 오류 해결 우선
6. **코드 품질**: ESLint 경고 해결 및 최적화
7. **성능 고려**: Hook 의존성 및 메모이제이션 최적화

---

## 6. 현재 상태 및 알려진 이슈

### 6.1 ✅ 완료된 기능
- 업종/테마 등락률 계산 및 상세 페이지 구현 (2025-06-17)
- krx_collector.py 과거 시세 백필 및 파생지표 보충 (2025-06-18)
- UI/차트/상세페이지 개선 및 Python import 표준화 (2025-06-18)
- 네이버 금융 재무정보 크롤러 구현 및 연간/분기 데이터 정확한 구분 처리 (2025-06-18)
  - 연간/분기 데이터를 정확하게 구분하여 DB에 저장
  - 배당금, 매출액, 영업이익 등 주요 재무지표 모두 정상 수집
  - 예상치(E) 데이터도 정확하게 구분하여 저장
  - financial_info 테이블에 period 컬럼('Y'/'Q')으로 연간/분기 구분

### 6.2 🔄 진행 중
- [ ] 테마 전체 페이지 확장/최적화(필요시)
- [ ] 테마/업종별 변화 이력 분석 및 리포트 자동화

### 6.4 🚨 알려진 이슈
- 테마정보는 일부 종목(662개)에만 매핑됨(네이버 첫 페이지 기준)
- StockThemes 테이블 구조 변경 시 기존 DB에 ALTER TABLE 필요(트러블슈팅 참고)
- 뉴스/이슈 데이터는 반드시 별도 테이블(NewsArticles, ArticleStockMap, ArticleThemeMap)로 관리해야 함(마스터 테이블 컬럼 추가 금지, 실전 확장성/성능/분석/LLM 연동 등 모든 측면에서 권장)

## 7.3 트러블슈팅/운영가이드 (추가)
- StockThemes 테이블 구조 변경(예: collected_at 컬럼 추가) 시 기존 DB에 ALTER TABLE로 컬럼 추가 필요
- 업종/테마 크롤러 실행 후 scripts/db_check.py로 매핑 현황(총 종목수, 업종/테마 매핑 종목수) 반드시 검증
- 테마정보는 네이버 첫 페이지만 수집 시 일부 종목만 매핑됨. 전체 테마 확장 필요시 크롤러 수정

---

# [2025-06-21] 모멘텀/지수/투자의견 분석 자동화 파이프라인 통합

- **scripts/run_momentum_analysis.py** 생성 및 정상 실행 확인
- 목적: 지수 데이터 수집→모멘텀 집계→투자의견 생성→성과/상관관계 분석까지 전체 파이프라인을 한 번에 자동 실행
- 위치: scripts/ (실험/운영 자동화, 실전 서비스와 분리)
- 사용법: 프로젝트 루트에서 `python scripts/run_momentum_analysis.py` 실행
- 각 단계별로 누락 데이터 자동 보충, 에러 발생 시 다음 단계로 진행
- 분석 결과는 results/ 폴더에 CSV로 저장, 로그로도 주요 성과/적중률/상관관계 출력
- 실전 신호/전략의 효과 검증 및 품질 개선, 운영 자동화에 활용

## scripts/ 폴더 주요 스크립트 역할 요약 (2025-06-21 기준)

| 파일명 | 역할/목적 |
| ------ | ------------------------------------------------------------ |
| run_momentum_analysis.py | 전체 파이프라인(지수→모멘텀→투자의견→백테스트) 자동 실행 |
| collect_market_index.py | 시장지수(KOSPI/KOSDAQ) 데이터 수집 및 모멘텀 계산/DB 저장 |
| backfill_daily_performance.py | 업종/테마 일별 성과 데이터 자동 보충 |
| backfill_investment_opinion.py | 투자 의견(investment_opinion) 자동 생성/보충 |
| backtest_momentum_strategy.py | 업종/테마/투자의견 모멘텀 전략 백테스트/성과 분석 |
| fill_missing_market_cap.py | 시가총액(market_cap) 누락분 보충(pykrx 활용) |
| migrate_add_leader_momentum.py | momentum_analysis 테이블에 leader 관련 컬럼 추가 |
| migrate_add_rsi.py | momentum_analysis 테이블에 RSI 컬럼 추가 |
| migrate_momentum_tables.py | SQL 스키마 파일을 DB에 일괄 적용(테이블 구조 마이그레이션) |
| migrate_add_summary_report.py | financial_evaluation 테이블에 summary_report 컬럼 추가 |
| migrate_industry_per.py | financial_info 테이블에 industry_per 컬럼 추가 |
| db_check.py | DB 내 업종/테마 매핑 현황 점검 및 통계 출력 |
| test_financial_crawler.py | (빈 파일) 재무 크롤러 테스트/임시 용도 |
| manual_update.py | (빈 파일) 수동 업데이트/임시 용도 |

---

# [2025-06-22] 투자분석기/모멘텀 파이프라인 구조분리 및 실전/실험/리포트 분리, 진단로그/결측치/분포/DB정상화, 브랜치 백업

- **분석기 구조/파이프라인**: 실전 가중치(`momentum_weights_active.csv`)와 실험/최적화 결과(`optimized_momentum_weights.csv`) 완전 분리. 실전 분석기는 운영용 가중치 이력만, 리포트/최적화/백테스트는 전체 결과 파일만 참조하도록 구조 분리.
- **진단/정상화**: 투자분석기(`investment_analyzer.py`)에 각 단계별 결측치/샘플/등급별 분포/DB 반영 여부를 명확히 로그로 남기도록 개선. trend_score, opinion_type이 DB에 정상 저장되는지, 그리고 UI/API에서 정상적으로 읽어오는지 최종 점검 완료.
- **실전/실험/리포트 파이프라인 완전 분리**: 실전 분석기는 실전 데이터/가중치만, 실험/리포트/최적화는 별도 파일/DB만 참조. 전체 파이프라인(시세수집→지표계산→주도주분석→투자의견→최적화/백테스트) 자동화 및 정상 동작 확인.
- **브랜치/백업**: win-250622-3 브랜치로 전체 변경사항 백업 및 깃에 반영 완료.
- **결과**: 모든 주요 컬럼/데이터 결측·이상치 없음, DB 저장/연동 정상, 로그 기반 진단 체계 구축. 실전/실험/리포트 파이프라인 구조가 명확히 분리되어 운영/확장/실험 모두 안전하게 진행 가능.

---

## [TODO] 다음 할 일 (2025-06-22)

- **모멘텀 분석기/백테스트/메인/실전/실험 통합 관리**
  - 현재 모멘텀 분석기가 UI 실행용, 메인 파이프라인, 모멘텀 백테스트 등 여러 파일로 분리되어 있음.
  - 각 파일에서 사용하는 분석 로직(지표 계산, 점수화 등)과 가중치가 분리/중복되어 관리되고 있어, 실전/실험/리포트/백테스트 결과가 불일치할 수 있음.
  - **목표:** 모멘텀 백테스트에서 개선된 가중치가 실전/메인/리포트/실험 등 모든 파이프라인에 자동 연동되어, 항상 동일한 분석로직과 가중치를 사용하도록 통합 관리하는 구조 설계 필요.
  - (예시: 분석기/가중치 로직을 별도 모듈화, 모든 파이프라인에서 import하여 일관성 보장)

- **[신규] 지수 적중률 기반 매수/투자의견 산출 로직 개발**
  - 시장지수(코스피/코스닥 등)의 모멘텀/적중률(예: 최근 상승률, 신호 적중률 등)을 업종/테마의 매수/투자의견 산출에 반영하는 로직을 개발할 것
  - 예시: 업종/테마 점수 산출 시 해당일 지수 모멘텀 또는 적중률을 가중치로 곱하거나, 지수 신호가 강할 때만 매수 의견을 강화하는 방식 등
  - 구체적 설계/실험/적용은 추후 논의 및 실전 데이터 기반으로 진행

- **volume/leader 계열 가중치가 최적화에서 항상 0이 나오는 원인 진단**
  - score 계산식(가중치 적용/목표함수) 코드 리뷰
  - volume/leader 값 분포, 결측률, 실제 score 반영 여부 로그 출력
  - 최적화 결과(조합별 성과)에서 volume/leader가 0이 아닐 때 성과 변화 분석
  - 데이터/전처리/정규화/제약조건 등 구조적 원인 점검

---

# [2025-06-23] 모멘텀/투자의견 산식, 정규화, 임계값 완전 공통화
- trend_score, opinion_type 산식/정규화/임계값을 src/analyzer/trend_score_utils.py 공통 모듈로 완전히 통일
- 실전(운영) 분석기(investment_analyzer.py)와 백테스트/최적화(optimize_momentum_weights.py, backtest_momentum_strategy.py 등) 모두 이 공통 함수만 사용하도록 구조 개선
- **가중치는 기존대로 momentum_weights_active.csv/optimized_momentum_weights.csv에서 관리**
- 산식/정규화/임계값만 코드 공통화, 가중치 파일 구조/적용 방식에는 변경 없음
- 실전/실험/리포트/백테스트 결과가 100% 일치하도록 신뢰도/유지보수성 대폭 향상

---

### [2025-06-23] 백테스트 추천 가중치와 실전 가중치의 값 일치 원칙
- 백테스트(최적화)에서 추천된 best_row(가중치)는 update_active_weights.py를 통해 momentum_weights_active.csv에 **값이 100% 동일하게 복사**됨
- **추가적인 값 보정, 스케일링, 변환 등은 없음**
- 실전 분석(운영)과 백테스트가 동일한 가중치로 동작하므로, 결과도 100% 일치
- 실전/백테스트의 오차는 "가중치가 다를 때만" 발생하며, 동일 가중치로 비교하면 오차 없음

---
