<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>종목 상세정보</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .section-title { font-weight: bold; margin-top: 24px; margin-bottom: 12px; }
        .dummy { color: #aaa; font-style: italic; }
        .chart-placeholder { height: 320px; background: #f3f3f3; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #bbb; font-size: 1.2em; width: 100%; }
        .positive { color: #d60000; }
        .negative { color: #0051c7; }
        .fin-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 14px;
        }
        .fin-table th, .fin-table td {
          border: none;
          border-bottom: 1px solid #e0e0e0;
          padding: 8px 4px;
          text-align: center;
        }
        .fin-table th {
          background: #fafbfc;
          font-weight: 600;
        }
        .fin-table tr:last-child td {
          border-bottom: none;
        }
        .fin-table td:first-child, .fin-table th:first-child {
          text-align: left;
        }
    </style>
</head>
<body>
<div class="container mt-4 mb-2">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb" id="breadcrumb-nav">
            <!-- JS로 동적 생성 -->
        </ol>
    </nav>
</div>
<div class="container mt-4 mb-5">
    <h2 id="stock-name">{{ stock_name }} <span class="text-muted" id="stock-code">({{ stock_code }})</span><span id="stock-change-rate" class="ms-2{% if change_rate|float > 0 %} positive{% elif change_rate|float < 0 %} negative{% endif %}">{% if change_rate != '정보 없음' %}{{ '%+.2f'|format(change_rate|float) }}%{% else %}정보 없음{% endif %}</span>{% if rebound_rate is not none %}<span class="rebound-rate-info ms-3{% if rebound_rate > 0 %} positive{% elif rebound_rate < 0 %} negative{% endif %}" style="font-size:16px;">(60일저점 반등률: {{ '%+.2f'|format(rebound_rate) }}%)</span>{% endif %}</h2>
    <div class="mb-3">
        <span class="me-3">업종: <span id="industry">{{ industry }}</span></span>
        <span class="me-3">테마: <span id="theme">{{ theme }}</span></span>
        <span class="me-3">시가총액: <span id="market-cap">{{ market_cap }}</span></span>
        <span class="me-3">상장시장: <span id="market-type">{{ market_type }}</span></span>
        <span class="me-3">상장일: <span id="listed-date">{{ listed_date }}</span></span>
    </div>
    <div class="section-title">최근 시세</div>
    <div class="row mb-3">
        <div class="col">현재가: <span id="close-price">{{ close_price }}</span></div>
        <div class="col">전일대비: <span id="change-rate">{{ change_rate }}</span></div>
        <div class="col">거래량: <span id="volume">{{ volume }}</span></div>
        <div class="col">거래대금: <span id="trading-value">{{ trading_value }}</span></div>
    </div>
    <div class="section-title">봉차트(캔들차트)</div>
    <div class="chart-placeholder mb-3" id="chart-area" style="width:100%;min-width:600px;height:350px;min-height:300px;box-sizing:border-box;overflow:visible;display:flex;align-items:center;justify-content:center;">
        <div id="price-chart" style="width:100%;height:100%;min-height:180px;"></div>
    </div>
    <div class="section-title">주요 파생지표</div>
    <div class="row mb-3">
        <div class="col">5일 평균 거래대금: <span id="avg-trading-5d">1,200억</span></div>
        <div class="col">60일 저점: <span id="low-60d">62,000</span></div>
        <div class="col">5/20/60일 이평선: <span id="ma">68,000 / 67,000 / 65,000</span></div>
    </div>
    <div class="section-title">최근 뉴스
        <button class="btn btn-sm btn-outline-primary ms-2" onclick="crawlNews()">뉴스 크롤러 실행</button>
    </div>
    <ul id="news-list" class="list-group mb-3">
        {% if news_list and news_list|length > 0 %}
            {% for news in news_list %}
                <li class="list-group-item">
                  <a href="{{ news.url }}" target="_blank">{{ news.title }}</a>
                  <span class="news-date text-muted small ms-2">
                    {% if news.days_diff == 0 %}오늘
                    {% elif news.days_diff is not none and 1 <= news.days_diff <= 5 %}{{ news.days_diff }}일전
                    {% else %}{{ news.date }}
                    {% endif %}
                  </span>
                  {% if news.summary %}<div class="news-summary text-muted small mt-1">{{ news.summary }}</div>{% endif %}
                </li>
            {% endfor %}
        {% else %}
            <li class="list-group-item dummy">뉴스 정보 없음 (크롤러 실행 시 최신 뉴스 표시)</li>
        {% endif %}
    </ul>
    <div class="section-title">재무 요약
      <button class="btn btn-sm btn-outline-primary ms-2" id="update-financial-btn" onclick="updateFinancial()">재무 업데이트</button>
    </div>
    <table class="fin-table" style="margin-bottom:32px;">
      <thead>
        <tr>
          <th>평가영역</th>
          <th>점수</th>
          <th>의견</th>
        </tr>
      </thead>
      <tbody id="fin-summary-tbody">
      {% if financial_evaluation %}
        {% set eval_row = financial_evaluation %}
        {% set eval_details = eval_details if eval_details is defined and eval_details else {} %}
        <tr><td>성장성</td><td>{{ '%.2f' % eval_row[3] }}{% if eval_details.get('growth', {}).get('grade') %} ({{ eval_details.get('growth', {}).get('grade') }}){% endif %}</td><td>{{ eval_details.get('growth', {}).get('description', '-') }}</td></tr>
        <tr><td>수익성</td><td>{{ '%.2f' % eval_row[4] }}{% if eval_details.get('profitability', {}).get('grade') %} ({{ eval_details.get('profitability', {}).get('grade') }}){% endif %}</td><td>{{ eval_details.get('profitability', {}).get('description', '-') }}</td></tr>
        <tr><td>안정성</td><td>{{ '%.2f' % eval_row[5] }}{% if eval_details.get('stability', {}).get('grade') %} ({{ eval_details.get('stability', {}).get('grade') }}){% endif %}</td><td>{{ eval_details.get('stability', {}).get('description', '-') }}</td></tr>
        <tr><td>시장가치</td><td>{{ '%.2f' % eval_row[6] }}{% if eval_details.get('market_value', {}).get('grade') %} ({{ eval_details.get('market_value', {}).get('grade') }}){% endif %}</td><td>{{ eval_details.get('market_value', {}).get('description', '-') }}</td></tr>
        <tr><td><b>종합</b></td><td>{{ '%.2f' % eval_row[7] }}{% if eval_details.get('total_grade') %} ({{ eval_details.get('total_grade') }}){% endif %}</td><td>{{ eval_row[8] or '-' }}</td></tr>
      {% else %}
        <tr><td>성장성</td><td>-</td><td>-</td></tr>
        <tr><td>수익성</td><td>-</td><td>-</td></tr>
        <tr><td>안정성</td><td>-</td><td>-</td></tr>
        <tr><td>시장가치</td><td>-</td><td>-</td></tr>
        <tr><td><b>종합</b></td><td>-</td><td>-</td></tr>
        <tr><td colspan="3" style="color:gray;">아직 재무 평가 정보가 없습니다.</td></tr>
      {% endif %}
      </tbody>
    </table>

    <table class="fin-table">
      <thead>
        <tr>
          <th rowspan="2">주요재무정보</th>
          {% for group in header_groups %}
            <th colspan="{{ group.colspan }}">{{ group.label }}</th>
          {% endfor %}
        </tr>
        <tr>
          {% for label in col_labels %}
            <th>{{ label }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody id="fin-info-tbody">
      {% set metrics = [
        ('매출액(억원)', 4), ('영업이익(억원)', 5), ('당기순이익(억원)', 6),
        ('영업이익률(%)', 7), ('순이익률(%)', 8), ('ROE(%)', 9),
        ('부채비율(%)', 10), ('당좌비율(%)', 11), ('유보율(%)', 12),
        ('EPS(원)', 13), ('PER(배)', 14), ('BPS(원)', 15),
        ('PBR(배)', 16), ('주당배당금(원)', 17), ('시가배당률(%)', 18), ('배당성향(%)', 19)
      ] %}
      {% if financial_info_list and financial_info_list|length > 0 %}
        {% set info_map = dict() %}
        {% for row in financial_info_list %}
          {% set key = (row[1], row[2]) %}
          {% set _ = info_map.update({key: row}) %}
        {% endfor %}
        {% for metric, idx in metrics %}
          <tr><td>{{ metric }}</td>
          {% for y, p in columns %}
            <td>{{ info_map[(y, p)][idx] if (y, p) in info_map else '-' }}</td>
          {% endfor %}
          </tr>
        {% endfor %}
      {% else %}
        <tr><td>매출액(억원)</td><td colspan="{{ columns|length }}" style="color:gray;">아직 재무정보가 수집되지 않았습니다.</td></tr>
        <tr><td>영업이익(억원)</td></tr>
        <tr><td>당기순이익(억원)</td></tr>
        <tr><td>영업이익률(%)</td></tr>
        <tr><td>순이익률(%)</td></tr>
        <tr><td>ROE(%)</td></tr>
        <tr><td>부채비율(%)</td></tr>
        <tr><td>당좌비율(%)</td></tr>
        <tr><td>유보율(%)</td></tr>
        <tr><td>EPS(원)</td></tr>
        <tr><td>PER(배)</td></tr>
        <tr><td>BPS(원)</td></tr>
        <tr><td>PBR(배)</td></tr>
        <tr><td>주당배당금(원)</td></tr>
        <tr><td>시가배당률(%)</td></tr>
        <tr><td>배당성향(%)</td></tr>
      {% endif %}
      </tbody>
    </table>

    <div class="section-title">외부 링크</div>
    <a href="https://finance.naver.com/item/main.naver?code=005930" target="_blank">네이버 증권</a>
</div>
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script>
let priceChart = null;
function crawlNews() {
    const btn = event.target;
    const code = document.getElementById('stock-code').textContent.replace(/[()]/g, '');
    btn.disabled = true;
    const original = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>크롤링 중...';
    fetch(`/api/stock/${code}/crawl_news`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                loadNewsList(code);
            } else {
                alert(data.message || '크롤링 실패');
            }
        })
        .catch(e => {
            alert('크롤링 중 오류 발생: ' + e);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = original;
        });
}
function loadNewsList(code) {
    fetch(`/api/stock/${code}/news`)
        .then(res => res.json())
        .then(data => {
            const newsList = document.getElementById('news-list');
            if (!data.news || data.news.length === 0) {
                newsList.innerHTML = '<li class="list-group-item dummy">뉴스 정보 없음 (크롤러 실행 시 최신 뉴스 표시)</li>';
                return;
            }
            newsList.innerHTML = data.news.map(n => {
                let dateStr = '';
                if (n.days_diff === 0) {
                  dateStr = '오늘';
                } else if (n.days_diff !== null && n.days_diff >= 1 && n.days_diff <= 5) {
                  dateStr = `${n.days_diff}일전`;
                } else {
                  dateStr = n.date;
                }
                return `<li class="list-group-item"><a href="${n.url}" target="_blank">${n.title}</a><span class='news-date text-muted small ms-2'>${dateStr}</span>${n.summary ? `<div class='news-summary text-muted small mt-1'>${n.summary}</div>` : ''}</li>`;
            }).join('');
        });
}
function renderCandleChart(code) {
    fetch(`/api/stock/${code}/ohlcv?days=60`)
        .then(res => res.json())
        .then(data => {
            if (!data.dates || data.dates.length === 0) {
                document.getElementById('price-chart').innerHTML = '<span class="dummy">차트 데이터 없음</span>';
                return;
            }
            document.getElementById('price-chart').innerHTML = '';
            const container = document.getElementById('chart-area');
            const priceWidth = Math.max(container.offsetWidth - 32, 100);
            const priceHeight = Math.max(container.offsetHeight - 32, 100);
            const priceContainer = document.getElementById('price-chart');
            priceContainer.style.width = priceWidth + 'px';
            priceContainer.style.height = priceHeight + 'px';
            priceChart = LightweightCharts.createChart(priceContainer, {
                width: priceWidth,
                height: priceHeight,
                layout: { background: { color: '#f3f3f3' }, textColor: '#222' },
                grid: { vertLines: { color: '#eee' }, horzLines: { color: '#eee' } },
                rightPriceScale: { borderColor: '#ccc', scaleMargins: { top: 0.2, bottom: 0.15 } },
                leftPriceScale: { scaleMargins: { top: 0.2, bottom: 0.15 } },
                timeScale: { borderColor: '#ccc', timeVisible: true, secondsVisible: false, rightOffset: 2, barSpacing: 8 }
            });
            const candleSeries = priceChart.addCandlestickSeries({
                upColor: '#d60000', // 빨강(상승)
                downColor: '#0051c7', // 파랑(하락)
                borderUpColor: '#d60000',
                borderDownColor: '#0051c7',
                wickUpColor: '#d60000',
                wickDownColor: '#0051c7'
            });
            const ohlc = data.dates.map((d, i) => ({
                time: Math.floor(new Date(d).getTime() / 1000),
                open: Number(data.open[i]),
                high: Number(data.high[i]),
                low: Number(data.low[i]),
                close: Number(data.close[i])
            }));
            candleSeries.setData(ohlc);
            priceChart.timeScale().fitContent();
        })
        .catch((e) => {
            console.error('차트 렌더링 오류:', e);
            document.getElementById('price-chart').innerHTML = '<span class="dummy">차트 데이터 없음</span>';
        });
}
window.addEventListener('resize', function() {
    const container = document.getElementById('chart-area');
    const priceContainer = document.getElementById('price-chart');
    if (priceChart && container && priceContainer) {
        const width = Math.max(container.offsetWidth - 32, 100);
        const height = Math.max(container.offsetHeight - 32, 100);
        priceContainer.style.width = width + 'px';
        priceContainer.style.height = height + 'px';
        priceChart.resize(width, height);
    }
});
if (window.ResizeObserver) {
    const container = document.getElementById('chart-area');
    const priceContainer = document.getElementById('price-chart');
    const ro = new ResizeObserver(() => {
        if (priceChart && container && priceContainer) {
            const width = Math.max(container.offsetWidth - 32, 100);
            const height = Math.max(container.offsetHeight - 32, 100);
            priceContainer.style.width = width + 'px';
            priceContainer.style.height = height + 'px';
            priceChart.resize(width, height);
        }
    });
    if (container) ro.observe(container);
}
document.addEventListener('DOMContentLoaded', function() {
    const code = '{{ stock_code }}';
    renderCandleChart(code);
    const params = new URLSearchParams(window.location.search);
    const from = params.get('from');
    const type = params.get('type');
    const id = params.get('id');
    const stockName = document.getElementById('stock-name')?.childNodes[0]?.textContent?.trim() || '종목상세';
    let upperName = '';
    let upperUrl = '';
    if (from && type && id) {
        // 업종/테마명은 이미 상세정보에 표시되어 있으므로 그대로 활용
        if (type === 'industry') {
            upperName = document.getElementById('industry')?.textContent || '업종상세';
            upperUrl = `/sector_detail?type=industry&id=${id}`;
        } else if (type === 'theme') {
            upperName = document.getElementById('theme')?.textContent || '테마상세';
            upperUrl = `/sector_detail?type=theme&id=${id}`;
        }
    }
    let html = '<li class="breadcrumb-item"><a href="/">Home</a></li>';
    if (upperName && upperUrl) {
        html += `<li class="breadcrumb-item"><a href="${upperUrl}">${upperName}</a></li>`;
    }
    html += `<li class="breadcrumb-item active" aria-current="page">${stockName}</li>`;
    document.getElementById('breadcrumb-nav').innerHTML = html;
    // 종목명 옆에 등락률 표시
    const changeRate = Number('{{ change_rate }}');
    const rateSpan = document.getElementById('stock-change-rate');
    if (!isNaN(changeRate)) {
        let colorClass = '';
        if (changeRate > 0) colorClass = 'positive';
        else if (changeRate < 0) colorClass = 'negative';
        rateSpan.className = `ms-2 ${colorClass}`;
        rateSpan.textContent = (changeRate > 0 ? '+' : '') + changeRate.toFixed(2) + '%';
    } else {
        rateSpan.textContent = '';
    }
});
function updateFinancial() {
  const btn = document.getElementById('update-financial-btn');
  const code = document.getElementById('stock-code').textContent.replace(/[()]/g, '');
  btn.disabled = true;
  const original = btn.innerHTML;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>진행중...';
  fetch(`/api/stock/${code}/update_financial`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        window.location.reload();
      } else {
        alert(data.message || '재무정보 갱신 실패');
        console.error('재무 업데이트 실패:', data);
      }
    })
    .catch(e => {
      alert('재무 업데이트 중 오류 발생: ' + e);
      console.error('재무 업데이트 오류:', e);
    })
    .finally(() => {
      btn.disabled = false;
      btn.innerHTML = original;
    });
}
// 재무 요약(평가) 표 갱신 함수
function renderFinancialSummary(evalRow) {
  const tbody = document.getElementById('fin-summary-tbody');
  if (!evalRow) {
    tbody.innerHTML = `<tr><td>성장성</td><td>-</td><td>-</td></tr>
      <tr><td>수익성</td><td>-</td><td>-</td></tr>
      <tr><td>안정성</td><td>-</td><td>-</td></tr>
      <tr><td>시장가치</td><td>-</td><td>-</td></tr>
      <tr><td><b>종합</b></td><td>-</td><td>-</td></tr>
      <tr><td colspan="3" style="color:gray;">아직 재무 평가 정보가 없습니다.</td></tr>`;
    return;
  }
  // evalRow: (id, ticker, eval_date, growth_score, profitability_score, stability_score, market_value_score, total_score, investment_opinion, evaluation_details, ...)
  const [id, ticker, eval_date, growth, profit, stability, market, total, opinion, details] = evalRow;
  let detailObj = {};
  try { detailObj = JSON.parse(details); } catch(e) {}
  tbody.innerHTML = `
    <tr><td>성장성</td><td>${growth?.toFixed(2) ?? '-'}</td><td>-</td></tr>
    <tr><td>수익성</td><td>${profit?.toFixed(2) ?? '-'}</td><td>-</td></tr>
    <tr><td>안정성</td><td>${stability?.toFixed(2) ?? '-'}</td><td>-</td></tr>
    <tr><td>시장가치</td><td>${market?.toFixed(2) ?? '-'}</td><td>-</td></tr>
    <tr><td><b>종합</b></td><td>${total?.toFixed(2) ?? '-'}</td><td>${opinion ?? '-'}</td></tr>
  `;
}
// 재무정보 표 갱신 함수
function renderFinancialInfo(finRow) {
  const tbody = document.getElementById('fin-info-tbody');
  if (!finRow) {
    tbody.innerHTML = `<tr><td>매출액(억원)</td><td colspan="{{ columns|length }}" style="color:gray;">아직 재무정보가 수집되지 않았습니다.</td></tr>
      <tr><td>영업이익(억원)</td></tr>
      <tr><td>당기순이익(억원)</td></tr>
      <tr><td>영업이익률(%)</td></tr>
      <tr><td>순이익률(%)</td></tr>
      <tr><td>ROE(%)</td></tr>
      <tr><td>부채비율(%)</td></tr>
      <tr><td>당좌비율(%)</td></tr>
      <tr><td>유보율(%)</td></tr>
      <tr><td>EPS(원)</td></tr>
      <tr><td>PER(배)</td></tr>
      <tr><td>BPS(원)</td></tr>
      <tr><td>PBR(배)</td></tr>
      <tr><td>주당배당금(원)</td></tr>
      <tr><td>시가배당률(%)</td></tr>
      <tr><td>배당성향(%)</td></tr>`;
    return;
  }
  // finRow: (ticker, year, period, is_estimate, revenue, operating_profit, net_profit, operating_margin, net_margin, roe, debt_ratio, quick_ratio, reserve_ratio, eps, per, bps, pbr, cash_dividend, dividend_yield, dividend_payout, ...)
  const [ticker, year, period, is_estimate, revenue, operating_profit, net_profit, operating_margin, net_margin, roe, debt_ratio, quick_ratio, reserve_ratio, eps, per, bps, pbr, cash_dividend, dividend_yield, dividend_payout] = finRow;
  tbody.innerHTML = `
    <tr><td>매출액(억원)</td><td colspan="{{ columns|length }}">${revenue ?? '-'}</td></tr>
    <tr><td>영업이익(억원)</td><td colspan="{{ columns|length }}">${operating_profit ?? '-'}</td></tr>
    <tr><td>당기순이익(억원)</td><td colspan="{{ columns|length }}">${net_profit ?? '-'}</td></tr>
    <tr><td>영업이익률(%)</td><td colspan="{{ columns|length }}">${operating_margin ?? '-'}</td></tr>
    <tr><td>순이익률(%)</td><td colspan="{{ columns|length }}">${net_margin ?? '-'}</td></tr>
    <tr><td>ROE(%)</td><td colspan="{{ columns|length }}">${roe ?? '-'}</td></tr>
    <tr><td>부채비율(%)</td><td colspan="{{ columns|length }}">${debt_ratio ?? '-'}</td></tr>
    <tr><td>당좌비율(%)</td><td colspan="{{ columns|length }}">${quick_ratio ?? '-'}</td></tr>
    <tr><td>유보율(%)</td><td colspan="{{ columns|length }}">${reserve_ratio ?? '-'}</td></tr>
    <tr><td>EPS(원)</td><td colspan="{{ columns|length }}">${eps ?? '-'}</td></tr>
    <tr><td>PER(배)</td><td colspan="{{ columns|length }}">${per ?? '-'}</td></tr>
    <tr><td>BPS(원)</td><td colspan="{{ columns|length }}">${bps ?? '-'}</td></tr>
    <tr><td>PBR(배)</td><td colspan="{{ columns|length }}">${pbr ?? '-'}</td></tr>
    <tr><td>주당배당금(원)</td><td colspan="{{ columns|length }}">${cash_dividend ?? '-'}</td></tr>
    <tr><td>시가배당률(%)</td><td colspan="{{ columns|length }}">${dividend_yield ?? '-'}</td></tr>
    <tr><td>배당성향(%)</td><td colspan="{{ columns|length }}">${dividend_payout ?? '-'}</td></tr>
  `;
}
</script>
</body>
</html> 