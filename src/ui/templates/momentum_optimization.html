<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>모멘텀 최적화 결과</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .theme-chip {
            display: inline-block;
            padding: 0px 4px;
            margin: 0px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #ddd;
        }
        .theme-chip:hover {
            background-color: #e0e0e0;
        }
        .theme-chip.active {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }
        .theme-chip.disabled {
            background-color: #e9ecef;
            color: #adb5bd;
            border-color: #dee2e6;
            cursor: not-allowed;
        }
        .theme-chip.reverse {
            background-color: #ffd700;
            color: #000;
            border-color: #ffc700;
        }
        .theme-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .fixed-chip {
            opacity: 1 !important;
            background-color: #007bff !important;
            color: #fff !important;
            border-color: #0056b3 !important;
            cursor: default !important;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>모멘텀 최적화 리포트</h2>
        <h5>사용 지표 선택</h5>
        <form method="post" action="/momentum-optimization/run" class="mb-3" id="factorForm">
            <div class="theme-container mb-2">
                {% for factor in meta['factors_base'] %}
                    {% if factor == 'price_momentum_3d' %}
                        <span class="theme-chip active disabled fixed-chip">주가모멘텀 3일</span>
                    {% elif factor == 'price_momentum_5d' %}
                        <span class="theme-chip active disabled fixed-chip">주가모멘텀 5일</span>
                    {% elif factor == 'price_momentum_10d' %}
                        <span class="theme-chip active disabled fixed-chip">주가모멘텀 10일</span>
                    {% elif factor == 'rsi_value' %}
                        <span class="theme-chip active disabled fixed-chip">RSI(과매수/과매도)</span>
                    {% else %}
                        <span class="theme-chip active disabled fixed-chip">{{ factor }}</span>
                    {% endif %}
                {% endfor %}
                {% for factor in meta['factors_optional'] %}
                    {% if factor == 'volume_momentum_1d' %}
                        <span class="theme-chip{% if factor in meta['selected_factors'] %} active{% endif %}" data-factor="{{ factor }}" onclick="toggleFactor(this, '{{ factor }}')">거래대금 1일</span>
                    {% elif factor == 'volume_momentum_3d' %}
                        <span class="theme-chip{% if factor in meta['selected_factors'] %} active{% endif %}" data-factor="{{ factor }}" onclick="toggleFactor(this, '{{ factor }}')">거래대금 3일</span>
                    {% elif factor == 'volume_momentum_5d' %}
                        <span class="theme-chip{% if factor in meta['selected_factors'] %} active{% endif %}" data-factor="{{ factor }}" onclick="toggleFactor(this, '{{ factor }}')">거래대금 5일</span>
                    {% elif factor == 'trend_score' %}
                        <span class="theme-chip{% if factor in meta['selected_factors'] %} active{% endif %}" data-factor="{{ factor }}" onclick="toggleFactor(this, '{{ factor }}')">추세점수</span>
                    {% elif factor == 'leader_count' %}
                        <span class="theme-chip{% if factor in meta['selected_factors'] %} active{% endif %}" data-factor="{{ factor }}" onclick="toggleFactor(this, '{{ factor }}')">주도주 수</span>
                    {% elif factor == 'leader_momentum' %}
                        <span class="theme-chip{% if factor in meta['selected_factors'] %} active{% endif %}" data-factor="{{ factor }}" onclick="toggleFactor(this, '{{ factor }}')">주도주 평균수익률</span>
                    {% else %}
                        <span class="theme-chip{% if factor in meta['selected_factors'] %} active{% endif %}" data-factor="{{ factor }}" onclick="toggleFactor(this, '{{ factor }}')">{{ factor }}</span>
                    {% endif %}
                {% endfor %}
            </div>
            <input type="hidden" name="direction_dict" id="directionDictInput" value="{}">
            <button type="submit" class="btn btn-primary">최적화 테스트 실행</button>
        </form>
        <script>
        // 3상태 칩 토글 및 direction dict 관리
        const factorList = Array.from(document.querySelectorAll('.theme-chip[data-factor]')).map(e=>e.getAttribute('data-factor'));
        let directionDict = {};
        factorList.forEach(f=>directionDict[f]=0);
        function updateDirectionInput() {
            document.getElementById('directionDictInput').value = JSON.stringify(directionDict);
        }
        function toggleFactor(elem, factor) {
            let state = directionDict[factor] || 0;
            state = state === 0 ? 1 : state === 1 ? -1 : 0;
            directionDict[factor] = state;
            elem.classList.remove('active','reverse');
            if(state === 1) { elem.classList.add('active'); elem.innerHTML = elem.innerText.replace(/[↑↓]/g,'') + ' ↑'; }
            else if(state === -1) { elem.classList.add('reverse'); elem.innerHTML = elem.innerText.replace(/[↑↓]/g,'') + ' ↓'; }
            else { elem.innerHTML = elem.innerText.replace(/[↑↓]/g,''); }
            updateDirectionInput();
        }
        window.onload = function() {
            document.querySelectorAll('.theme-chip[data-factor]').forEach(function(elem){
                let factor = elem.getAttribute('data-factor');
                directionDict[factor] = 0;
                elem.classList.remove('active','reverse');
                elem.innerHTML = elem.innerText.replace(/[↑↓]/g,'');
            });
            updateDirectionInput();
        }
        </script>
        {% if running %}
        <div class="alert alert-info">최적화 테스트 실행 중입니다... 잠시만 기다려주세요.</div>
        {% endif %}
        <hr>
        <!-- 1. 실험 메타데이터 -->
        <h5>실험 정보</h5>
        <ul>
            <li><b>실험일:</b> {{ meta['실험일'] }}</li>
            <li><b>데이터 구간:</b> {{ meta['데이터 구간'] }}</li>
            <li><b>가중치 조합 수:</b> {{ meta['조합수'] }}</li>
        </ul>
        <!-- 2. 가중치 조합 비교 -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">가중치 조합 비교</h5>
            <button id="applyWeightsBtn" class="btn btn-success">추천 가중치 적용</button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead>
                    <tr><th>지표(방향)</th><th>현재 가중치</th><th>추천 가중치</th></tr>
                </thead>
                <tbody>
                    {% for row in weight_compare %}
                    <tr>
                        <td>{{ row['지표'] }}</td>
                        <td {% if row['현재'] == 0 %}style="color: #bbb;"{% endif %}>{{ '%.2f'|format(row['현재']) }} <span>{% if row['현재_화살표'] %}{{ row['현재_화살표'] }}{% endif %}</span></td>
                        <td {% if row['추천'] == 0 %}style="color: #bbb;"{% endif %}>{{ '%.2f'|format(row['추천']) }} <span>{% if row['추천_화살표'] %}{{ row['추천_화살표'] }}{% endif %}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- 3. 성과(적중률/수익률) 비교 -->
        <h5>적중률/수익률 개선 효과</h5>
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th>기간</th>
                        <th>현재 BUY 적중률(%)</th>
                        <th>추천 BUY 적중률(%)</th>
                        <th>현재 BUY 평균수익률(%)</th>
                        <th>추천 BUY 평균수익률(%)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for n in available_periods %}
                    <tr>
                        <td><b>{{ n }}일</b></td>
                        <td>{{ '%.2f'|format(base_res['BUY_hit_rate_' ~ n ~ 'd']) if base_res['BUY_hit_rate_' ~ n ~ 'd'] not in [None, '-', ''] else '-' }}</td>
                        <td {% if best_row['BUY_hit_rate_' ~ n ~ 'd'] == max_hit %}style="background-color: #ffe5e5;"{% endif %}>{{ '%.2f'|format(best_row['BUY_hit_rate_' ~ n ~ 'd']) if best_row['BUY_hit_rate_' ~ n ~ 'd'] not in [None, '-', ''] else '-' }}</td>
                        <td>{{ '%.2f'|format(base_res['BUY_avg_return_' ~ n ~ 'd']) if base_res['BUY_avg_return_' ~ n ~ 'd'] not in [None, '-', ''] else '-' }}</td>
                        <td {% if best_row['BUY_avg_return_' ~ n ~ 'd'] == max_return %}style="background-color: #ffe5e5;"{% endif %}>{{ '%.2f'|format(best_row['BUY_avg_return_' ~ n ~ 'd']) if best_row['BUY_avg_return_' ~ n ~ 'd'] not in [None, '-', ''] else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- 4. 최고 성과 조합/가중치 -->
        <h5>최고 성과 조합</h5>
        {% if best_row %}
        <div class="card mb-3">
            <div class="card-body">
                <b>가중치 조합:</b>
                <ul>
                {% for k, v in best_row.items() if not k.startswith('BUY_hit_rate_') and not k.startswith('BUY_avg_return_') %}
                    <li>{{ k }}: {{ '%.2f'|format(v) if v is number else v }}</li>
                {% endfor %}
                </ul>
                {% for n in available_periods %}
                <b>{{ n }}일 BUY 적중률:</b> {{ best_row['BUY_hit_rate_' ~ n ~ 'd'] if best_row['BUY_hit_rate_' ~ n ~ 'd'] != None else '-' }}%<br>
                <b>{{ n }}일 BUY 평균수익률:</b> {{ best_row['BUY_avg_return_' ~ n ~ 'd'] if best_row['BUY_avg_return_' ~ n ~ 'd'] != None else '-' }}%<br>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <p>최고 성과 조합 데이터가 없습니다.</p>
        {% endif %}
        <!-- 5. 상위 5개 조합 요약 -->
        <h5>상위 5개 조합 요약</h5>
        {% if top_rows %}
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        {% for k in top_rows[0].keys() %}
                        <th>{{ k }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in top_rows %}
                    <tr>
                        {% for v in row.values() %}
                        <td>{{ '%.2f'|format(v) if v is number else v }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>상위 조합 데이터가 없습니다.</p>
        {% endif %}
        <!-- 6. 전체 표(선택) -->
        <details class="mt-3">
            <summary>전체 결과 표 보기</summary>
            <div class="table-responsive mt-2">
                {{ table_html|safe }}
            </div>
        </details>
        <!-- 실제 적용된 가중치(최신) 표시 -->
        <h5 class="mt-4">실제 적용된 가중치(최신)</h5>
        {% if active_weights %}
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        {% for k in active_weights.keys() %}
                        <th>{{ k }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        {% for v in active_weights.values() %}
                        <td>{{ v }}</td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
        {% else %}
        <p>적용된 가중치 정보를 불러올 수 없습니다.</p>
        {% endif %}
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('applyWeightsBtn').onclick = function() {
                if (!confirm('추천 가중치를 실전 가중치로 반영하시겠습니까?')) return;
                fetch('/api/update_active_weights', {method: 'POST'})
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            showWeightsModal(data.applied_weights);
                        } else {
                            alert('반영 실패: ' + data.message);
                        }
                    })
                    .catch(err => alert('API 호출 오류: ' + err));
            };
        });
        function showWeightsModal(weights) {
            let html = '<div class="modal fade" id="weightsModal" tabindex="-1" aria-labelledby="weightsModalLabel" aria-hidden="true">';
            html += '<div class="modal-dialog"><div class="modal-content">';
            html += '<div class="modal-header"><h5 class="modal-title" id="weightsModalLabel">추천 가중치가 성공적으로 반영되었습니다</h5>';
            html += '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>';
            html += '<div class="modal-body">';
            html += '<table class="table table-bordered table-sm"><thead><tr><th>지표</th><th>값</th></tr></thead><tbody>';
            for (const [k, v] of Object.entries(weights)) {
                html += `<tr><td>${k}</td><td>${typeof v === 'number' ? v.toFixed(4) : v}</td></tr>`;
            }
            html += '</tbody></table></div>';
            html += '<div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button></div>';
            html += '</div></div></div>';
            let modalDiv = document.createElement('div');
            modalDiv.innerHTML = html;
            document.body.appendChild(modalDiv);
            let modal = new bootstrap.Modal(modalDiv.querySelector('.modal'));
            modal.show();
            modalDiv.querySelector('.modal').addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modalDiv);
                location.reload(); // 새로고침(최신 가중치/리포트 반영)
            });
        }
        </script>
        <a href="/" class="btn btn-secondary mt-3">메인으로 돌아가기</a>
        <!-- 날짜별 추천가중치 결과표 -->
        <hr class="mt-5">
        <h5 class="mt-4">날짜별 추천가중치 테스트 결과</h5>
        <div class="table-responsive">
            {{ momentum_daily_table_html|safe }}
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 